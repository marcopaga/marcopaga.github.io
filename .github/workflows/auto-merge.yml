name: Auto Merge

on:
  pull_request_target:
    types: [opened, synchronize, labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Only run for renovate or owner with automerge label
    if: |
      github.event.pull_request.user.login == 'renovate[bot]' ||
      (github.event.pull_request.user.login == github.repository_owner &&
       contains(github.event.pull_request.labels.*.name, 'automerge'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for major updates
        id: check
        env:
          PR_LABELS: ${{ toJSON(github.event.pull_request.labels.*.name) }}
        run: |
          # Don't auto-merge major updates
          if echo "$PR_LABELS" | grep -q "major-update"; then
            echo "Major update detected - skipping auto-merge"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Enable auto-merge
        if: steps.check.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "Enabling auto-merge for PR #$PR_NUMBER"
          gh pr merge $PR_NUMBER --auto --squash --delete-branch --repo ${{ github.repository }}
