name: Auto Merge

on:
  workflow_run:
    workflows: ["Test Build and Content"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request' &&
      (github.event.workflow_run.actor.login == github.repository_owner ||
       github.event.workflow_run.actor.login == 'renovate[bot]')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get PR number
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --json number,headRefName --state open --jq ".[] | select(.headRefName==\"${{ github.event.workflow_run.head_branch }}\") | .number")
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Found PR #$PR_NUMBER"

      - name: Enable auto-merge for PR
        if: steps.pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Tests passed successfully! Enabling auto-merge for PR #${{ steps.pr.outputs.pr_number }}"
          gh pr merge "${{ steps.pr.outputs.pr_number }}" --auto --squash --delete-branch
