<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Marco Paga"><meta name=description content="https://marco-paga.eu"><meta name=keywords content="blog,developer,personal"><meta property="og:site_name" content="Marco Paga"><meta property="og:title" content="
  Tekton Triggers CEL - Marco Paga
"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://marco-paga.eu/entries/tekton-triggers-cel/"><meta property="og:image" content="https://marco-paga.eu"><meta name=twitter:card content="summary"><meta name=twitter:site content="https://marco-paga.eu/entries/tekton-triggers-cel/"><meta name=twitter:image content="https://marco-paga.eu"><base href=https://marco-paga.eu/entries/tekton-triggers-cel/><title>Tekton Triggers CEL - Marco Paga</title><link rel=canonical href=https://marco-paga.eu/entries/tekton-triggers-cel/><link rel=stylesheet href=/css/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=alternate href=https://marco-paga.eu/index.xml type=application/rss+xml title="Marco Paga"><link href=https://marco-paga.eu/index.xml rel=feed type=application/rss+xml title="Marco Paga"><meta name=generator content="Hugo 0.104.2"></head><body><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Marco Paga</a>
<input type=checkbox id=menu-control>
<label class="menu-mobile float-right" for=menu-control><span class="btn-mobile float-right">&#9776;</span><ul class=navigation-list><li class="navigation-item align-center"><a class=navigation-link href=https://marco-paga.eu/index.html>Start</a></li><li class="navigation-item align-center"><a class=navigation-link href=https://marco-paga.eu/articles>Articles</a></li><li class="navigation-item align-center"><a class=navigation-link href=https://marco-paga.eu/entries>Posts</a></li><li class="navigation-item align-center"><a class=navigation-link href=https://marco-paga.eu/about-me>About me</a></li><li class="navigation-item align-center"><a class=navigation-link href=https://marco-paga.eu/impressum>Imprint</a></li></ul></label></section></nav><div class=content><section class="container page"><article><header><h1>Tekton Triggers CEL</h1></header><p><em>or how to convert a git ref to a branch name</em></p><p><a href=https://github.com/tektoncd/triggers>Tekton Triggers</a> is a Tekton project which allows to receive webhooks and react appropriately to those. You can follow along <a href=https://blog.codecentric.de/en/2022/03/tekton-triggers-in-practice/>my article on the codecentric blog</a> to see what is possible.</p><p>Tekton triggers includes a conecpt which is called <a href=https://github.com/tektoncd/triggers/blob/main/docs/interceptors.md>Interceptors</a> that provide a way to implement cross cutting concerns.
To give you a quick example: If you integrate Github with Tekton you hopefully want to validate if <strong>your</strong> project is calling the tekton installation since you don&rsquo;t want anybody stumbling on your tekton installation to run pipelines. How hard can it be? Just have a look at the <a href=https://docs.github.com/en/developers/webhooks-and-events/webhooks/securing-your-webhooks>documentation</a> and see that you need to exchange secrests and need to run HMAC on the encoded request. Long story short: Just integrate the <a href=https://github.com/tektoncd/triggers/blob/main/docs/interceptors.md#github-interceptors>GitHub</a> interceptor and you are done.</p><p>And now another simple problem. When gitlab triggers a webhook the branch name is included in the request but contained in a git reference. This is great but what if I just need the branch name?
One way to handle it is to create a task that gets the reference as a parameter and returns just the branch name as an out parameter. This is quite a big overhead so maybe there is a simpler solution.</p><h2 id=common-expression-language-interceptor>Common Expression Language Interceptor</h2><p>The common expression language is a simple expression language based on protobuf types. The implementation used in the context of tekton is the <a href=https://github.com/google/cel-go/>go implementation called cel-go</a>.
If you integrate the CEL interceptor in the EventListener you can manipulate the request and find the results in the trigger bindings in a field called <strong>extensions</strong>.</p><p>Find a short example here where I configured the interceptor to return the branch name:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl> triggers:
</span></span><span class=line><span class=cl>    - name: gitlab-push-events-trigger
</span></span><span class=line><span class=cl>      interceptors:
</span></span><span class=line><span class=cl>        - name: &#34;verify-gitlab-payload&#34;
</span></span><span class=line><span class=cl>          ref:
</span></span><span class=line><span class=cl>            name: &#34;gitlab&#34;
</span></span><span class=line><span class=cl>            kind: ClusterInterceptor
</span></span><span class=line><span class=cl>          params:
</span></span><span class=line><span class=cl>            - name: secretRef
</span></span><span class=line><span class=cl>              value:
</span></span><span class=line><span class=cl>                secretName: &#34;gitlab-secret&#34;
</span></span><span class=line><span class=cl>                secretKey: &#34;secretToken&#34;
</span></span><span class=line><span class=cl>            - name: eventTypes
</span></span><span class=line><span class=cl>              value:
</span></span><span class=line><span class=cl>                - &#34;Push Hook&#34;
</span></span><span class=line><span class=cl>        - ref:
</span></span><span class=line><span class=cl>            name: cel
</span></span><span class=line><span class=cl>          params:
</span></span><span class=line><span class=cl>            - name: &#34;overlays&#34;
</span></span><span class=line><span class=cl>              value:
</span></span><span class=line><span class=cl>                - key: branch_name
</span></span><span class=line><span class=cl>                  expression: &#34;body.ref.split(&#39;/&#39;)[2]&#34;
</span></span><span class=line><span class=cl>      bindings:
</span></span><span class=line><span class=cl>        - name: git-revision
</span></span><span class=line><span class=cl>          value: $(body.checkout_sha)
</span></span><span class=line><span class=cl>        - name: git-repository-url
</span></span><span class=line><span class=cl>          value: $(body.repository.git_http_url)
</span></span><span class=line><span class=cl>        - name: git-branch
</span></span><span class=line><span class=cl>          value: $(extensions.branch_name)
</span></span></code></pre></div><p>The branch is extracted in the last two lines so these can be sent over to the triggered pipeline.</p><h2 id=recap>Recap</h2><p>As you can see we simply changed a request field to make it easily consumable from our pipeline.</p></article></section></div><footer class=footer><section class=container><div class="sns-shares sp-sns-shares"><a class="sns-share twitter-share" href="https://twitter.com/intent/tweet?original_referer=https%3a%2f%2fmarco-paga.eu%2fentries%2ftekton-triggers-cel%2f&ref_src=twsrc%5Etfw&text=Tekton%20Triggers%20CEL Marco%20Paga&tw_p=tweetbutton&url=https%3a%2f%2fmarco-paga.eu%2fentries%2ftekton-triggers-cel%2f"><i class="fab fa-twitter"></i></a>
<a class="sns-share linkedIn-share" href="https://www.linkedin.com/sharing/share-offsite/?url=https%3a%2f%2fmarco-paga.eu%2fentries%2ftekton-triggers-cel%2f"><i class="fab fa-linkedin"></i></a></div><p>✌️</p>Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/naro143/hugo-coder-portfolio>CoderPortfolio</a>.</section></footer><div class=fixed-bar><section class=container><div class="sns-shares pc-sns-shares"><a class="sns-share twitter-share" href="https://twitter.com/intent/tweet?original_referer=https%3a%2f%2fmarco-paga.eu%2fentries%2ftekton-triggers-cel%2f&ref_src=twsrc%5Etfw&text=Tekton%20Triggers%20CEL Marco%20Paga&tw_p=tweetbutton&url=https%3a%2f%2fmarco-paga.eu%2fentries%2ftekton-triggers-cel%2f"><i class="fab fa-twitter"></i></a>
<a class="sns-share linkedIn-share" href="https://www.linkedin.com/sharing/share-offsite/?url=https%3a%2f%2fmarco-paga.eu%2fentries%2ftekton-triggers-cel%2f"><i class="fab fa-linkedin"></i></a></div></section></div></main><script src=/js/app.js></script></body></html>